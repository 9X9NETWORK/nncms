/*!
 * jQuery Title Card Player plugin
 *
 * @requires    jQuery Core v1.8 or later
 * @requires    jQuery UI v1.8.23 or later
 * @requires    9x9 SDK (nn-sdk.js)
 * @author      Chih-Wen Yang <chihwen@doubleservice.com>
 * @version     1.6.3
 *
 * - Change Log:
 *      1.6.3:  2013/09/06 - add new requirement text can be empty by Mars.
 *      1.6.2:  2013/06/11 - Some minor cleanup to pass JSLint coding quality tool check (http://www.jslint.com/).
 *      1.6.1:  2013/05/24 - Some minor cleanup to pass JSLint coding quality tool check (http://www.jslint.com/).
 *      1.6.0:  2012/10/24 - 1. Detect both width and height then decide calculate title card size according to width or to height.
 *                           2. Title card size will be 16:9, so there might be black area on the left & right, or top & bottom.
 *                           3. Improved background image and background color switch rule due to system default background image.
 *      1.5.0:  2012/10/18 - 1. Added private strip_tags() method to strip HTML tags (html/script injection, XSS).
 *                           2. Added private destroy() method to encapsulate destroy (or cancel) feature.
 *                           3. Added optional widescreen option [boolean], default is true to keep 16:9 aspect ratio (easter egg option).
 *                           4. Added optional height option [integer], default is null (easter egg option).
 *                           5. Added {BR} transfer to html br tag.
 *                           6. Listened resize event to automaticly react with the canvas width (without reload plugin).
 *      1.4.0:  2012/10/01 - 1. Adjusted html structure (added wrapper-middle div) for effect improvement.
 *                           2. Setup all nn.log() to debug level for turn off console log by default.
 *      1.3.2:  2012/09/13 - 1. Adjusted duration distribution feature by effect kind (drop).
 *                           2. Adjusted effect hide behavior (immediate disappear no animate).
 *      1.3.1:  2012/09/13 - 1. Improved cancel (stop) feature.
 *                           2. Some minor cleanup.
 *      1.3.0:  2012/09/12 - 1. Added startStandbySec and endingStandbySec feature.
 *                           2. Adjusted duration distribution feature by effect kind (blind, clip).
 *                           3. Added none, bounce, drop, explode, highlight, puff, pulsate, scale, shake, slide effect.
 *                           4. Some minor improvements and cleanup.
 *      1.2.1:  2012/09/12 - 1. Some minor cleanup to pass JSLint coding quality tool check (http://www.jslint.com/).
 *                           2. predefine global variables: jQuery nn.
 *                           3. JSLint Directive Options: jslint eqeq: true, sloppy: true, vars: true.
 *      1.2.0:  2012/09/12 - 1. Adjusted effect feature only act on font, not on background color and image.
 *                           2. Added text on textarea manual line feed feature.
 *                           3. Added optional width option (easter egg option).
 *                           4. Some minor improvements and cleanup.
 *      1.1.0:  2012/09/11 - 1. Added font radix feature, fontSize value between 6 and 48,
 *                              and default is 20. (player screen keep 16:9 ratio.)
 *                           2. Added effect feature, default is fade. (fade, blind, clip, fold.)
 *                           3. Added duration feature, duration value between 5 and 20,
 *                              and default is 7. (start 1.5 sec. + delay + ending 1.5 sec.)
 *                           4. Added played callback feature.
 *                           5. Added cancel callback feature.
 *                           6. Added param verify and normalize feature.
 *                           7. Added background image feature.
 *      1.0.0:  2012/09/10 - Initial release.
 *
 * -------------------------------------------
 * Example:
 * -------------------------------------------
 *
 * <script src="jquery.titlecard.js"></script>
 * <div id="canvas"></div>
 * <script>
 * $('#canvas').titlecard({
 *     text: 'My video',
 *     align: 'center',
 *     effect: 'clip',
 *     duration: 10,
 *     fontSize: 20,
 *     fontColor: 'white',
 *     fontStyle: 'italic',
 *     fontWeight: 'bold',
 *     backgroundColor: 'black',
 *     backgroundImage: 'http://ecample.com/sample.jpg'
 * }, function () {
 *     // call back after title card played
 * });
 * // cancel playing title card and release resources
 * $('#canvas').titlecard('cancel', function () {});
 * </script>
 *
 * -------------------------------------------
 * Lists of possible parameter combinations:
 * -------------------------------------------
 *
 * play with default values
 * $('#canvas').titlecard();
 *
 * play with parameters
 * $('#canvas').titlecard(parameters);
 *
 * play with parameters and calls callback function
 * $('#canvas').titlecard(parameters, callback);
 *
 * play with default values and calls callback function
 * $('#canvas').titlecard(callback);
 * $('#canvas').titlecard(null, callback);  // easter egg method overloading
 *
 * cancel playing title card and release resources
 * $('#canvas').titlecard('cancel');
 *
 * cancel playing title card, release resources, and calls callback function
 * $('#canvas').titlecard('cancel', callback);
 */
(function(a){a.fn.titlecard=function(c,i){nn.log({options:c,callback:i},"debug");
var f=function(j,l){l=l||"";l+="";l=(l.toLowerCase().match(/<[a-z][a-z0-9]*>/g)||[]).join("");var k=/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,m=/<!--[\s\S]*?-->|<\?(?:php)?[\s\S]*?\?>/gi;
return j.replace(m,"").replace(k,function(o,n){return l.indexOf("<"+n.toLowerCase()+">")>-1?o:"";});};var d=function(k,l){var j=null;if("function"===typeof l){j=l;
}k.clearQueue().stop().children().clearQueue().stop().children().clearQueue().stop().children().clearQueue().stop().end().end().hide("fast",j);};var g=null,b=null;
if(undefined===c){nn.log("play with default values","debug");g=null;}else{var h=false;if("string"===typeof c){if("cancel"===c){h=true;if("function"===typeof i){nn.log("setup cancel callback","debug");
b=i;}nn.log("cancel playing title card, release resources","debug");d(a(this),b);}else{nn.log("param error nothing to do","error");}return;}if("function"===typeof c||"function"===typeof i){nn.log("setup played callback","debug");
if("function"===typeof c){h=true;g=c;c={};}else{g=i;}}if("object"===typeof c){h=true;nn.log("setup options","debug");}if(!h){nn.log("param error nothing to do","error");
return;}}var e=a.extend({},a.fn.titlecard.defaults,c||{});nn.log({opts:e,playedCallback:g},"debug");return this.each(function(){var s=a(this),E=(e.width&&e.width<=s.width())?parseInt(e.width,10):s.width(),C=(e.height&&e.height<=s.height())?parseInt(e.height,10):s.height(),J=0,t="none",G=0,y=f(a.trim(e.text)).replace(/(\n|\{BR\})/g,"<br />")||"<br />",H=e.align,F=parseInt(e.fontSize,10),n=0,o=e.fontStyle,w=e.fontWeight,k=(this.id)?(this.id+"-"):"",r=k+"wrapper-canvas",v=k+"wrapper-outer",z=k+"wrapper-middle",u=k+"wrapper-inner",D="";
if(""!==e.backgroundImage){e.backgroundColor="";}if(e.widescreen){J=Math.round((E/16)*9);if(J>C){E=Math.round((C/9)*16);}else{C=J;}}if(s.height()>C){t="left";
G=((s.height()-C)/2)+"px";}if(F<a.fn.titlecard.allows.fontSize.min||F>a.fn.titlecard.allows.fontSize.max){F=a.fn.titlecard.defaults.fontSize;}n=Math.round(E/F);
if(-1===a.inArray(H,a.fn.titlecard.allows.align)){H=a.fn.titlecard.defaults.align;}if(-1===a.inArray(o,a.fn.titlecard.allows.fontStyle)){o=a.fn.titlecard.defaults.fontStyle;
}if(-1===a.inArray(w,a.fn.titlecard.allows.fontWeight)){w=a.fn.titlecard.defaults.fontWeight;}D='<div class="'+r+'"><div class="'+v+'">';D+='<div class="'+z+'"><div class="'+u+'"></div></div>';
if((""!==e.backgroundImage&&""===e.backgroundColor)||(""!==e.backgroundImage&&""!==e.backgroundColor&&a.fn.titlecard.system.backgroundImage!==e.backgroundImage)){D+='<img src="'+e.backgroundImage+'" style="width: 100%; height: 100%; border: none;" />';
}D+="</div></div>";s.show().wrapInner(D).children("."+r).hide().css({display:"block",width:"100%",height:"100%",backgroundColor:"#000"}).children("."+v).hide().css({display:"block",position:"relative",overflow:"hidden",zIndex:50,"float":t,width:E+"px",height:C+"px",margin:G+" auto",backgroundColor:e.backgroundColor}).children("."+z).hide().css({display:"block",position:"absolute",width:"100%",height:"100%"}).children("."+u).hide().html(y).css({display:"block",position:"absolute",left:"1%",width:"98%",height:"auto",textAlign:H,fontSize:n+"pt",color:e.fontColor,fontStyle:o,fontWeight:w});
var m=s.children().children("."+v).children("."+z).children("."+u).width(),L=s.children().children("."+v).children("."+z).children("."+u).height(),x=0,l=0;
if(E>m){x=(E-m)/2;}if(C>L){l=(C-L)/2;}s.children().children("."+v).children("."+z).children("."+u).css({top:l+"px",left:x+"px"});var A=e.effect,j=parseInt(e.duration,10),K=500,q=500,B=1500,I=1500,p=3000;
if(-1===a.inArray(A,a.fn.titlecard.allows.effect)){A=a.fn.titlecard.defaults.effect;}if(j<a.fn.titlecard.allows.duration.min||j>a.fn.titlecard.allows.duration.max){j=a.fn.titlecard.defaults.duration;
}j*=1000;if(-1!==a.inArray(A,["blind","clip","drop"])){B=I=1000;}if("none"===A){K=q=B=I=0;}p=(j-K-B-I-q);switch(A){case"blind":case"clip":case"fold":case"drop":case"bounce":case"explode":case"highlight":case"puff":case"pulsate":case"scale":case"shake":case"slide":s.children().children().show(K).children("."+z).hide().show(A,{},B).delay(p).hide(A,{},I,function(){s.children().delay(q).hide(0,g);
});break;case"fade":s.children().children().show(K).children("."+z).hide().fadeIn(B).delay(p).fadeOut(I,function(){s.children().delay(q).hide(0,g);});break;
default:s.children().children().children().show(0).delay(j).hide(0,function(){s.children().hide(0,g);});break;}a(window).bind("resize",function(){var N=s.width(),S=s.height(),Q=0,O="none",P=0;
if(e.widescreen){Q=Math.round((N/16)*9);if(Q>S){N=Math.round((S/9)*16);}else{S=Q;}}if(s.height()>S){O="left";P=((s.height()-S)/2)+"px";}s.children().children("."+v).css({"float":O,width:N,height:S,margin:P+" auto"}).children("."+z).children("."+u).css({fontSize:Math.round(N/F)+"pt"});
var R=s.children().children("."+v).children("."+z).children("."+u).width(),T=s.children().children("."+v).children("."+z).children("."+u).height(),U=0,M=0;
if(N>R){U=(N-R)/2;}if(S>T){M=(S-T)/2;}s.children().children("."+v).children("."+z).children("."+u).css({top:M+"px",left:U+"px"});});});};a.fn.titlecard.defaults={widescreen:true,width:null,height:null,text:" ",align:"center",effect:"none",duration:7,fontSize:20,fontColor:"white",fontStyle:"normal",fontWeight:"normal",backgroundColor:"black",backgroundImage:""};
a.fn.titlecard.allows={align:["left","center","right"],effect:["none","fade","blind","clip","fold","drop","bounce","explode","highlight","puff","pulsate","scale","shake","slide"],duration:{min:5,max:20},fontSize:{min:6,max:48},fontStyle:["normal","italic"],fontWeight:["normal","bold","bolder"]};
a.fn.titlecard.system={backgroundImage:"http://9x9ui.s3.amazonaws.com/war/v0/images/titlecard-default.png"};}(jQuery));